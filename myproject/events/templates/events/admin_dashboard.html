{% extends 'base.html' %}

{% block title %}Admin Dashboard - EventManager{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="bi bi-speedometer2"></i> Admin Dashboard</h2>

<!-- Stats Cards -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="card stats-card bg-primary-gradient">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-0">Total Users</h6>
                    <h2 class="mb-0">{{ total_users }}</h2>
                </div>
                <i class="bi bi-people" style="font-size:2.5rem;opacity:0.5;"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card bg-success-gradient">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-0">Total Bookings</h6>
                    <h2 class="mb-0">{{ total_bookings }}</h2>
                </div>
                <i class="bi bi-ticket" style="font-size:2.5rem;opacity:0.5;"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card bg-warning-gradient">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-0">Total Revenue</h6>
                    <h2 class="mb-0">Rs.{{ total_revenue }}</h2>
                </div>
                <i class="bi bi-currency-rupee" style="font-size:2.5rem;opacity:0.5;"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card bg-info-gradient">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-0">Quick Actions</h6>
                </div>
                <i class="bi bi-lightning" style="font-size:2.5rem;opacity:0.5;"></i>
            </div>
            <a href="{% url 'events:event_create' %}" class="btn btn-light btn-sm mt-2">+ Add Event</a>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-4 mb-4">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5>Monthly Revenue</h5>
                <canvas id="revenueChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5>Events by Category</h5>
                <canvas id="categoryChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Recent Bookings -->
<div class="card shadow-sm">
    <div class="card-body">
        <h5>Recent Bookings</h5>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>User</th>
                        <th>Event</th>
                        <th>Guests</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in recent_bookings %}
                    <tr>
                        <td>{{ booking.pk }}</td>
                        <td>{{ booking.user.username }}</td>
                        <td>{{ booking.event.title }}</td>
                        <td>{{ booking.number_of_guests }}</td>
                        <td>Rs.{{ booking.total_amount }}</td>
                        <td><span class="badge badge-{{ booking.status }}">{{ booking.get_status_display }}</span></td>
                        <td>{{ booking.created_at|date:"M d, Y" }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="7" class="text-center text-muted">No bookings yet</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Monthly Revenue Chart
    var revenueCtx = document.getElementById('revenueChart').getContext('2d');
    var monthlyData = {{ monthly_revenue|safe }};
    new Chart(revenueCtx, {
        type: 'bar',
        data: {
            labels: monthlyData.map(function(item) {
                var d = new Date(item.month);
                return d.toLocaleDateString('en-US', {month: 'short', year: 'numeric'});
            }),
            datasets: [{
                label: 'Revenue (Rs.)',
                data: monthlyData.map(function(item) { return parseFloat(item.total); }),
                backgroundColor: 'rgba(13, 110, 253, 0.7)',
                borderRadius: 5,
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
    });

    // Category Distribution Chart
    var catCtx = document.getElementById('categoryChart').getContext('2d');
    var catData = {{ category_counts|safe }};
    new Chart(catCtx, {
        type: 'doughnut',
        data: {
            labels: catData.map(function(item) { return item.category__name; }),
            datasets: [{
                data: catData.map(function(item) { return item.count; }),
                backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#6f42c1', '#0dcaf0'],
            }]
        },
        options: { responsive: true }
    });
</script>
{% endblock %}